<html>

<head>

<title>framework_test</title>

<script type="text/javascript" src="javascript/mootools.js"></script>
<script type="text/javascript">

	var echoSocket = new WebSocket("ws://localhost:9292",[]);

	echoSocket.onopen = function(e) {
		// Check the protocol chosen by the server
		console.log("Protocol: " + echoSocket.protocol);
		console.log("readyState: " + echoSocket.readyState);
		echoSocket.send("\x06"); // send initialization signal (ASCII 'ACKNOWLEDGE'
	};

	echoSocket.onmessage = function(e) {
		var message = e.data;

		console.log("Message:");

		// check for JSON prefix
		console.log("First character code point is: " + message.charCodeAt(0));
		if (message.charCodeAt(0) == 1) {
			console.log("JSON detected");
			message = message.slice(1);
			console.log(JSON.stringify(JSON.parse(message), null, 2));
		} else {
			console.log(message);
		}
		
	};

	window.addEvent("domready", function() {
	
		document.id("submit").addEvent('click', function() {
			var message = $("input").get('value');

			// if JSON, prepend \x01
			if ($("json").checked) {
				message = "\x01" + message;
			}

			echoSocket.send(message);
		});

		document.id("submit_close").addEvent('click', function() {
			echoSocket.close(parseInt($("close_code").value), $("close_reason").value);
		});

	});

	window.addEvent("unload", function() {
		console.log("unloading");
		echoSocket.close(1001);
	});

</script>

</head>

<body>
	<h1>Ruby Framework Test</h1>
	<h2>Websocket</h2>
	<h3>Message<h3>
	<input id="input" type="text"/>
	<label for="json">JSON?</label>
	<input id="json" type="checkbox"/>
	<input id="submit" type="submit"/>
	<h3>Close</h3>
	<label for="close_code">Code</label>
	<input id="close_code" type="text"/>
	<label for="close_reason">Reason</label>
	<input id="close_reason" type="text"/>
	<input id="submit_close" type="submit"/>

</body>

</html>
